<form class="w-full h-full rounded-sm bg-slate-100 p-5 flex flex-col gap-4 overflow-x-auto relative" [formGroup]="studentProfileField">
    <div class="flex-auto rounded-md w-full flex gap-2 p-2 flex-col">
      <div class="h-[30rem] w-full flex bg-white shadow-lg">
        <table class="h-full border border-collapse flex w-full table-condensed">
          <thead class="flex flex-col h-full justify-around w-[25%]">
            <tr class="w-full h-full">
              <th class="p-2 h-[10%] flex border border-slate-600 items-start flex-wrap">
                Student No<span class="text-red-600">*</span>
              </th>
              <th class="p-2 h-[10%] flex border border-slate-600 items-start">
                First Name<span class="text-red-600">*</span>
              </th>
              <th class="p-2 h-[10%] flex border border-slate-600 items-start">
                Middle Name
              </th>
              <th class="p-2 h-[10%] flex border border-slate-600 items-start">
                Last Name<span class="text-red-600">*</span>
              </th>
              <th class="p-2 h-[10%] flex border border-slate-600 items-start">
                Contact No.<span class="text-red-600">*</span>
              </th>
              <th class="p-2 h-[10%] flex border border-slate-600 items-start">
                Email<span class="text-red-600">*</span>
              </th>
              <th class="p-2 h-[10%] flex border border-slate-600 items-start">
                Year of Admission<span class="text-red-600">*</span>
              </th>
              <th class="p-2 h-[10%] flex border border-slate-600 items-start">
                Curriculum<span class="text-red-600">*</span>
              </th>
              <th class="p-2 h-[10%] flex border border-slate-600 items-start">
                Year Level
              </th>
              <th class="p-2 h-[10%] flex border border-slate-600 items-start">
                Status
              </th>
            </tr>
          </thead>
          <tbody class="flex-auto flex flex-col h-full">
            <tr class="w-full h-full flex flex-col">
              <td class="border-slate-600 border h-[10%] relative group/studentid">
                <input
                  class="w-full p-2 h-full group/studentid"
                  [ngClass]="{'border-red-600 border-[1px]': studentProfileField.get('studentid')?.invalid }"
                  formControlName="studentid"/>
                  @if(studentProfileField.get('studentid')?.invalid) {
                    <img class="absolute right-0 top-0 h-full" src="../../../assets/exclamation-mark-inside-a-circle-svgrepo-com.svg"/>
                    <div class="w-0 h-0 opacity-0 studentid group-hover/studentid:opacity-100 group-focus/studentid:opacity-100 absolute top-[80%] right-4 border-l-[5px] border-l-transparent border-b-[10px] border-b-black border-r-[5px] border-r-transparent">
                    </div>
                    <div class="z-50 bg-black rounded-md absolute min-w-[20px] min-h-[30px] text-white top-[100%] right-0 p-2 opacity-0 group-hover/studentid:opacity-100 group-focus/studentid:opacity-100">
                      @if(studentProfileField.get('studentid')?.hasError('required')){
                        Student ID is required!
                      }@else if (studentProfileField.get('studentid')?.hasError('duplicate')){
                        Student ID is already in use!
                      }@else if(studentProfileField.get('studentid')?.hasError('invalidId')){
                        Student ID is in invalid format!
                      }
                    </div>

                  }
              </td>
              <td class="border-slate-600 border h-[10%] relative group/userfname">
                <input
                  class="w-full p-2 h-full group/userfname"
                  formControlName="userfname"
                  [ngClass]="{'border-red-600 border-[1px]': studentProfileField.get('userfname')?.invalid }"/>
                @if(studentProfileField.get('userfname')?.invalid) {
                  <img class="absolute right-0 top-0 h-full" src="../../../assets/exclamation-mark-inside-a-circle-svgrepo-com.svg"/>
                  <div class="group-focus/userfname:opacity-100 w-0 h-0 opacity-0 group-hover/userfname:opacity-100 absolute top-[80%] right-4 border-l-[5px] border-l-transparent border-b-[10px] border-b-black border-r-[5px] border-r-transparent">
                  </div>
                  <div class="group-hover/userfname:opacity-100 group-focus/userfname:opacity-100 z-50 bg-black rounded-md absolute min-w-[20px] min-h-[30px] text-white top-[100%] right-0 p-2 opacity-0">
                    @if(studentProfileField.get('userfname')?.hasError('required')){
                      First name is required!
                    }@else if (studentProfileField.get('userfname')?.hasError('pattern')) {
                      First name is in invalid format!
                    }
                  </div>
                }
              </td>
              <td class="border-slate-600 border h-[10%] relative group/usermiddle">
                <input class="w-full p-2 h-full group/usermiddle"
                  [ngClass]="{'border-red-600 border-[1px]': studentProfileField.get('usermiddle')?.invalid }"
                  formControlName="usermiddle"/>
                @if(studentProfileField.get('usermiddle')?.invalid) {
                  <img class="absolute right-0 top-0 h-full" src="../../../assets/exclamation-mark-inside-a-circle-svgrepo-com.svg"/>
                  <div class="w-0 h-0 opacity-0 group-focus/usermiddle:opacity-100 group-hover/usermiddle:opacity-100 absolute top-[80%] right-4 border-l-[5px] border-l-transparent border-b-[10px] border-b-black border-r-[5px] border-r-transparent">
                  </div>
                  <div class="bg-black rounded-md absolute min-w-[20px] min-h-[30px] z-50 group-focus/usermiddle:opacity-100 text-white top-[100%] right-0 p-2 opacity-0 group-hover/usermiddle:opacity-100">
                    @if(studentProfileField.get('usermiddle')?.hasError('required')){
                      Middle name is required!
                    }@else if (studentProfileField.get('usermiddle')?.hasError('pattern')) {
                      Middle name is in invalid format!
                    }
                  </div>
                }
              </td>
              <td class="border-slate-600 border h-[10%] relative group/userlname">
                <input class="w-full p-2 h-full group/userlname"
                [ngClass]="{'border-red-600 border-[1px]': studentProfileField.get('userlname')?.invalid }"
                formControlName="userlname"/>
                @if(studentProfileField.get('userlname')?.invalid) {
                  <img class="absolute right-0 top-0 h-full" src="../../../assets/exclamation-mark-inside-a-circle-svgrepo-com.svg"/>
                  <div class="w-0 h-0 opacity-0 group-focus/userlname:opacity-100 group-hover/userlname:opacity-100 absolute top-[80%] right-4 border-l-[5px] border-l-transparent border-b-[10px] border-b-black border-r-[5px] border-r-transparent">
                  </div>
                  <div class="bg-black rounded-md absolute min-w-[20px] min-h-[30px] z-50 group-focus/userlname:opacity-100 text-white top-[100%] right-0 p-2 opacity-0 group-hover/userlname:opacity-100">
                    @if(studentProfileField.get('userlname')?.hasError('required')){
                      Last name is required!
                    }@else if (studentProfileField.get('userlname')?.hasError('pattern')) {
                      Last name is in invalid format!
                    }
                  </div>
                }
              </td>
              <td class="border-slate-600 border h-[10%] relative group/contact_no">
                <input class="w-full p-2 h-full group/contact_no"
                  [ngClass]="{'border-red-600 border-[1px]': studentProfileField.get('contact_no')?.invalid }"
                  formControlName="contact_no"/>
                @if(studentProfileField.get('contact_no')?.invalid) {
                  <img class="absolute right-0 top-0 h-full" src="../../../assets/exclamation-mark-inside-a-circle-svgrepo-com.svg"/>
                  <div class="w-0 h-0 opacity-0 group-focus/contact_no:opacity-100 group-hover/contact_no:opacity-100 absolute top-[80%] right-4 border-l-[5px] border-l-transparent border-b-[10px] border-b-black border-r-[5px] border-r-transparent">
                  </div>
                  <div class="bg-black rounded-md absolute min-w-[20px] min-h-[30px] z-50 group-focus/contact_no:opacity-100 text-white top-[100%] right-0 p-2 opacity-0 group-hover/contact_no:opacity-100">
                    @if(studentProfileField.get('contact_no')?.hasError('required')){
                      Contact number is required!
                    }
                    @else if(studentProfileField.get('contact_no')?.hasError('pattern')){
                      Contact number is in invalid format!
                    }
                  </div>
                }
              </td>
              <td class="border-slate-600 border h-[10%] relative group/email">
                <input class="w-full p-2 h-full group/email"
                  [ngClass]="{'border-red-600 border-[1px]': studentProfileField.get('email')?.invalid }"
                  formControlName="email"/>
                  @if(studentProfileField.get('email')?.invalid) {
                    <img class="absolute right-0 top-0 h-full" src="../../../assets/exclamation-mark-inside-a-circle-svgrepo-com.svg"/>
                    <div class="w-0 h-0 opacity-0 group-focus/email:opacity-100 group-hover/email:opacity-100 absolute top-[80%] right-4 border-l-[5px] border-l-transparent border-b-[10px] border-b-black border-r-[5px] border-r-transparent">
                    </div>
                    <div class="bg-black rounded-md absolute min-w-[20px] min-h-[30px] z-50 group-focus/email:opacity-100 text-white top-[100%] right-0 p-2 opacity-0 group-hover/email:opacity-100">
                      @if(studentProfileField.get('email')?.hasError('required')){
                        Email is required!
                      }@else if(studentProfileField.get('email')?.hasError('email')){
                        Email is in invalid format!
                      } @else if(studentProfileField.get('email')?.hasError('emailDomain')){
                        Email only accepts Baliuag University Email Address!
                      }
                      @else if(studentProfileField.get('email')?.hasError('duplicate')){
                        Email is already in use!
                      }
                    </div>
                  }
              </td>
              <td class="border-slate-600 border h-[10%] relative group/sy">
                <select class="w-full p-2 h-full group/sy"
                [ngClass]="{'border-red-600 border-[1px]': studentProfileField.get('sy')?.invalid }"
                formControlName="sy">
                  <option [ngValue]="null" disabled selected>
                    Please Select
                  </option>
                  @for(sy of school_years; track $index){
                    <option [ngValue]="sy.sy">
                      {{ sy.sy_start  + " - " + sy.sy_end }}
                    </option>
                  }
                </select>
                @if(studentProfileField.get('sy')?.invalid) {
                  <img class="absolute right-0 top-0 h-full" src="../../../assets/exclamation-mark-inside-a-circle-svgrepo-com.svg"/>
                  <div class="w-0 h-0 opacity-0 group-focus/sy:opacity-100 group-hover/sy:opacity-100 absolute top-[80%] right-4 border-l-[5px] border-l-transparent border-b-[10px] border-b-black border-r-[5px] border-r-transparent">
                  </div>
                  <div class="bg-black rounded-md absolute min-w-[20px] min-h-[30px] z-50 group-focus/sy:opacity-100 text-white top-[100%] right-0 p-2 opacity-0 group-hover/sy:opacity-100">
                    Year of admission is required!
                  </div>
                }
              </td>
              <td class="border-slate-600 border h-[10%] relative group/program">
                <select class="w-full p-2 h-full border-[0px] group/program"
                  [ngClass]="{'border-red-600 border-[1px]': studentProfileField.get('curriculum')?.invalid }"
                  (change)="changeCurriculum()"
                  formControlName="curriculum">
                  <option [ngValue]="null" disabled selected>
                    N/A
                  </option>
                  @for(curriculum of curricula; track $index){
                    <option [ngValue]="curriculum.cid">
                      {{curriculum.program.programcode + (curriculum.specialization ? curriculum.specialization : "") + " (" + curriculum.school_year.sy_start + " - " + curriculum.school_year.sy_end + ")"  }}
                    </option>
                  }
                </select>
                @if(studentProfileField.get('curriculum')?.invalid) {
                  <img class="absolute right-0 top-0 h-full" src="../../../assets/exclamation-mark-inside-a-circle-svgrepo-com.svg"/>
                  <div class="w-0 h-0 opacity-0 group-focus/program:opacity-100 group-hover/program:opacity-100 absolute top-[80%] right-4 border-l-[5px] border-l-transparent border-b-[10px] border-b-black border-r-[5px] border-r-transparent">
                  </div>
                  <div class="bg-black rounded-md absolute min-w-[20px] min-h-[30px] z-50 group-focus/program:opacity-100 text-white top-[100%] right-0 p-2 opacity-0 group-hover/program:opacity-100">
                    Curriculum is required!
                  </div>
                }
              </td>

              <td class="border-slate-600 border h-[10%] relative group/year_level">
                <span class="flex items-start w-full h-full p-2">
                  {{ studentProfile?.student_record?.year_level ?  studentProfile?.student_record?.year_level?.year_level_desc : "To be determined" }}
                </span>

              </td>
              <td class="border-slate-600 border h-[10%] relative group/status">
                <span class="flex items-start w-full h-full p-2">
                  {{ studentProfile?.student_record.status }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      @if(!loading.loading){
        <div class="h-[50rem] w-full border-[1px] border-slate-300 rounded-md bg-white overflow-y-scroll">
          @for(c of curriculumSubjects; track $index){
            <table class="table-auto w-full border-collapse border border-slate-300">
              <thead  class="h-[3rem]">
                <tr class="flex flex-row p-2 w-full border-b-[1px] border-slate-300 relative">
                  <th class="flex justify-center w-full">
                   LEVEL {{
                    c.year  == 1 ? 'I' :
                    (c.year  == 2 ? 'II':
                    (c.year  == 3 ? 'III':
                     'IV'))
                    }}
                  </th>

                </tr>
                <tr class="flex flex-row py-2 w-full border-b-[1px] border-slate-300">
                  <th class="flex justify-center w-full">
                     {{
                      c.semester  == 1 ? '1ST' :
                      (c.semester == 2 ? '2ND':
                      '3RD')
                    }} TRIMESTER
                  </th>
                </tr>
                <tr class="flex flex-row border-b-[1px] border-slate-300">
                  <th class="w-[10%] border-slate-300 border-[1px] flex items-center justify-center">
                    Grade
                  </th>
                  <th class="w-[12%] border-slate-300 border-[1px] flex items-center justify-center">
                    Course Code
                  </th>
                  <th class="w-[30%] border-slate-300 border-[1px] flex items-center justify-center">
                    Course Title
                  </th>
                  <th class="w-[12%] border-slate-300 border-[1px] flex items-center justify-center">
                    Units
                  </th>
                  <th class="w-[12%] border-slate-300 border-[1px] flex flex-col items-center justify-center">
                    <span class="border-slate-300 border-[1px] w-full flex items-center justify-center" >Units</span>
                    <div class="flex flex-row w-full">
                      <span class="flex border-[1px] w-full border-slate-300 items-center justify-center">
                        Lec
                      </span>
                      <span class="flex border-[1px] w-full border-slate-300 items-center justify-center">
                        Lab
                      </span>
                    </div>
                  </th>
                  <th class="w-[12%] border-slate-300 border-[1px] flex flex-col items-center justify-center">
                    <span class="border-slate-300 border-[1px] w-full flex items-center justify-center" >Hours</span>
                    <div class="flex flex-row w-full">
                      <span class="flex border-[1px] w-full border-slate-300 items-center justify-center">
                        Lec
                      </span>
                      <span class="flex border-[1px] w-full border-slate-300 items-center justify-center">
                        Lab
                      </span>
                    </div>
                  </th>
                  <th class="w-[12%] border-slate-300 border-[1px] flex items-center justify-center">
                    Prerequisite/s
                  </th>
                </tr>
              </thead>
              <tbody class="flex flex-col w-full">
                @for(s of c.subjects; let i = $index; track i){
                  <tr class="flex flex-row border-b-[1px] border-slate-300">
                    <td class="w-[10%] border-slate-300 border-[1px] flex items-center justify-center">
                      <select class="p-2 border-slate-300 border-[1px] w-full h-full" (change)="handleGradeControl(s.coursecode, $event)" [ngModel]="getSubjectTakenValue(s.coursecode)" [ngModelOptions]="{standalone:true}" [disabled]="!gradeEditable && getSubjectTakenValue(s.coursecode).length != 0">
                        <option [value]="''">
                          None
                        </option>
                        @for(g of grades; track $index){
                          <option [value]="g">
                            {{ g }}
                          </option>
                        }
                      </select>
                    </td>
                    <td class="w-[12%] p-2 border-slate-300 border-[1px] flex items-center justify-center">
                      {{ s.coursecode }}
                    </td>
                    <td class="w-[30%] p-2 border-slate-300 border-[1px] flex items-center justify-center">
                      {{ s.coursedescription }}
                    </td>
                    <td class="w-[12%] p-2 border-slate-300 border-[1px] flex items-center justify-center">
                      {{ s.units }}
                    </td>
                    <td class="w-[6%] p-2 border-slate-300 border-[1px] flex flex-col items-center justify-center">
                      {{ s.unitslec }}
                    </td>
                    <td class="w-[6%] p-2 border-slate-300 border-[1px] flex flex-col items-center justify-center">
                      {{ s.unitslab }}
                    </td>
                    <td class="w-[6%] p-2 border-slate-300 border-[1px] flex flex-col items-center justify-center">
                      {{ s.hourslec }}
                    </td>
                    <td class="w-[6%] p-2 border-slate-300 border-[1px] flex flex-col items-center justify-center">
                      {{ s.hourslab }}
                    </td>
                    <td class="w-[12%] p-2 border-slate-300 border-[1px] flex items-center justify-center">
                      {{ s.prerequisites }}
                    </td>
                  </tr>
                }
              </tbody>
              <tfoot class="flex flex-col w-full">
                <tr class="flex flex-row border-b-[1px] border-slate-300 w-full">
                  <td class="w-[10%] p-2 border-slate-300 border-[1px] flex items-center justify-center">
                  </td>
                  <td class="w-[12%] p-2 border-slate-300 border-[1px] flex items-center justify-center">
                  </td>
                  <td class="w-[30%] p-2 border-slate-300 border-[1px] flex items-center justify-center font-bold">
                    Total
                  </td>
                  <td class="w-[12%] p-2 border-slate-300 border-[1px] flex items-center justify-center">
                    {{ totalSum($index, 'units') }}
                  </td>
                  <td class="w-[6%] p-2 border-slate-300 border-[1px] flex flex-col items-center justify-center">
                    {{ totalSum($index, 'unitslec') }}
                  </td>
                  <td class="w-[6%] p-2 border-slate-300 border-[1px] flex flex-col items-center justify-center">
                    {{ totalSum($index, 'unitslab') }}
                  </td>
                  <td class="w-[6%] p-2 border-slate-300 border-[1px] flex flex-col items-center justify-center">
                    {{ totalSum($index, 'hourslec') }}
                  </td>
                  <td class="w-[6%] p-2 border-slate-300 border-[1px] flex flex-col items-center justify-center">
                    {{ totalSum($index, 'hourslab') }}
                  </td>
                  <td class="w-[12%] p-2 border-slate-300 border-[1px] flex items-center justify-center">
                  </td>
                </tr>
                <tr class="flex w-full min-h-[1.23rem] bg-slate-200">
                  <td class="w-full bg-slate-200 border-[1px] flex items-center justify-center">
                  </td>
                </tr>
              </tfoot>
            </table>
          }
        </div>
      }
      <div class="flex h-[3rem] justify-end gap-2">
        <a [routerLink]="'/students'" class="w-full flex flex-row gap-2 items-center justify-center px-4 bg-slate-700 py-2 rounded-md text-white hover:bg-slate-900 transition-all uppercase">
          <i class="material-symbols-outlined">
            close
          </i>
          <span class="hidden lg:block">
            Discard Changes
          </span>
        </a>
        <button class="w-full flex flex-row gap-2 px-4 py-2 items-center justify-center bg-green-600 border-[1px] rounded-md text-white transition-all hover:bg-green-800 uppercase" (click)="handleSubmit()">
          <i class="material-symbols-outlined">edit</i>
          <span class="hidden lg:block">
            Save Changes
          </span>
        </button>
      </div>
    </div>
    @if(loading.loading){
      <app-loading-component></app-loading-component>
    }
  </form>
