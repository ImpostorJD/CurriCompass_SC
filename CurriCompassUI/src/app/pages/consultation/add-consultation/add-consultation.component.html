<form class="w-full h-full bg-slate-100 flex flex-col gap-3 py-4 px-2" [formGroup]="semConsultation">
  <h1 class="text-[2rem] font-bold font-poppins">Add Consultation</h1>
  <div class="w-full bg-white shadow-lg">
    <table class="flex table-auto flex-row">
      <thead class="flex min-w-[15rem]">
        <tr class="w-full flex flex-col">
          <th class="h-[3rem] p-2 w-full border-[1px] border-black flex items-start">
            Curriculum
          </th>
          <th class="h-[3rem] p-2 w-full border-[1px] border-black flex items-start">
            School Year
          </th>
          <th class="h-[3rem] p-2 w-full border-[1px] border-black flex items-start">
            Semesters
          </th>
          <th class="h-[3rem] p-2 w-full border-[1px] border-black flex items-start">
            Year Level
          </th>
          <th class="h-[3rem] p-2 w-full border-[1px] border-black flex items-start">
            Block
          </th>
        </tr>
      </thead>
      <tbody class="flex w-full">
        <tr class="flex flex-col w-full">
          <td class="h-[3rem] w-full border-[1px] border-black flex items-start relative group/cid">
            <select class="h-full w-full p-2" formControlName="cid" [ngClass]="{'border-red-600 border-[1px]': semConsultation.get('cid')?.invalid }">
              <option [ngValue]="null" selected disabled>
                Please Select
              </option>
              @for(c of curricula; track $index){
                <option [ngValue]="c.cid">
                  {{ c.program.programdesc + (c.specialization) ? ' specialization in ' + c.specialization : '' }}
                </option>
              }
            </select>
            @if(semConsultation.get('cid')?.invalid) {
              <img class="absolute right-0 top-0 h-full" src="../../../assets/exclamation-mark-inside-a-circle-svgrepo-com.svg"/>
              <div class="w-0 h-0 opacity-0 group-hover/cid:opacity-100 group-focus/cid:opacity-100 absolute top-[80%] right-4 border-l-[5px] border-l-transparent border-b-[10px] border-b-black border-r-[5px] border-r-transparent">
              </div>
              <div class="z-50 bg-black rounded-md absolute min-w-[20px] min-h-[30px] text-white top-[100%] right-0 p-2 opacity-0 group-hover/cid:opacity-100 group-focus/cid:opacity-100">
                @if(semConsultation.get('cid')?.hasError('required')){
                  Curriculum is required!
                }@else if (semConsultation.get('cid')?.hasError('duplicate')) {
                  Combination already exists!
                }
              </div>
            }
          </td>
          <td class="h-[3rem] w-full border-[1px] border-black flex items-start relative group/sy">
            <select class="h-full w-full p-2" formControlName="sy" [ngClass]="{'border-red-600 border-[1px]': semConsultation.get('sy')?.invalid }">
              <option [ngValue]="null" selected disabled>
                Please Select
              </option>
              @for(sy of schoolYears; track $index){
                <option [ngValue]="sy.sy">
                  {{ sy.sy_start }}
                </option>
              }
            </select>
            @if(semConsultation.get('sy')?.invalid) {
              <img class="absolute right-0 top-0 h-full" src="../../../assets/exclamation-mark-inside-a-circle-svgrepo-com.svg"/>
              <div class="w-0 h-0 opacity-0 group-hover/sy:opacity-100 group-focus/sy:opacity-100 absolute top-[80%] right-4 border-l-[5px] border-l-transparent border-b-[10px] border-b-black border-r-[5px] border-r-transparent">
              </div>
              <div class="z-50 bg-black rounded-md absolute min-w-[20px] min-h-[30px] text-white top-[100%] right-0 p-2 opacity-0 group-hover/sy:opacity-100 group-focus/sy:opacity-100">
                @if(semConsultation.get('sy')?.hasError('required')){
                  School year is required!
                }
              </div>
            }
          </td>
          <td class="h-[3rem] w-full border-[1px] border-black flex items-start relative group/semid">
            <select class="h-full w-full p-2" formControlName="semid" [ngClass]="{'border-red-600 border-[1px]': semConsultation.get('semid')?.invalid }">
              <option [ngValue]="null" selected disabled>
                Please Select
              </option>
              @for(sem of semesters; track $index){
                <option [ngValue]="sem.semid">
                  {{ sem.semdesc }}
                </option>
              }
            </select>
            @if(semConsultation.get('semid')?.invalid) {
              <img class="absolute right-0 top-0 h-full" src="../../../assets/exclamation-mark-inside-a-circle-svgrepo-com.svg"/>
              <div class="w-0 h-0 opacity-0 group-hover/semid:opacity-100 group-focus/semid:opacity-100 absolute top-[80%] right-4 border-l-[5px] border-l-transparent border-b-[10px] border-b-black border-r-[5px] border-r-transparent">
              </div>
              <div class="z-50 bg-black rounded-md absolute min-w-[20px] min-h-[30px] text-white top-[100%] right-0 p-2 opacity-0 group-hover/semid:opacity-100 group-focus/semid:opacity-100">
                @if(semConsultation.get('semid')?.hasError('required')){
                  Semester is required!
                }
              </div>
            }
          </td>
          <td class="h-[3rem] w-full border-[1px] border-black flex items-start group/year_level relative">
            <select class="h-full w-full p-2" formControlName="year_level" [ngClass]="{'border-red-600 border-[1px]': semConsultation.get('year_level')?.invalid }">
              <option [ngValue]="null" selected disabled>
                Please Select
              </option>
              <option value="1st Year">
                1st Year
              </option>
              <option value="2nd Year">
                2nd Year
              </option>
              <option value="3rd Year">
                3rd Year
              </option>
              <option value="4th Year">
                4th Year
              </option>
            </select>
            @if(semConsultation.get('year_level')?.invalid) {
              <img class="absolute right-0 top-0 h-full" src="../../../assets/exclamation-mark-inside-a-circle-svgrepo-com.svg"/>
              <div class="w-0 h-0 opacity-0 group-hover/year_level:opacity-100 group-focus/year_level:opacity-100 absolute top-[80%] right-4 border-l-[5px] border-l-transparent border-b-[10px] border-b-black border-r-[5px] border-r-transparent">
              </div>
              <div class="z-50 bg-black rounded-md absolute min-w-[20px] min-h-[30px] text-white top-[100%] right-0 p-2 opacity-0 group-hover/year_level:opacity-100 group-focus/year_level:opacity-100">
                @if(semConsultation.get('year_level')?.hasError('required')){
                  Year level is required!
                }
              </div>
            }
          </td>
          <td class="h-[3rem] w-full border-[1px] border-black flex items-start">
            <input class="w-full h-full p-2" placeholder="leave null if not applicable" formControlName="section">
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="mx-1 border-slate-400 rounded-md border-[1px] p-2 bg-white h-[5rem] flex flex-col">
    <span>Search For Courses</span>
    <div class="relative w-full">
      <input class="w-full p-2 border-[1px] border-slate-400 rounded-md" [(ngModel)]="searchCourse" [ngModelOptions]="{standalone:true}">
      <i class="text-slate-400 material-symbols-outlined absolute right-[0.5%] bottom-[20%]">
        search
      </i>
    </div>
  </div>
  <div class="w-full">
    <table class="w-full table-auto flex flex-col bg-white">
      <thead class="flex w-full bg-slate-300 rounded-t-md">
        <tr class="flex flex-row w-full">
          <th class="w-[16.67%] h-full border-[1px] border-black p-2 rounded-tl-md">
            Course
          </th>
          <th class="w-[16.67%] h-full border-[1px] border-black p-2">
            Descriptive Title
          </th>
          <th class="w-[16.67%] h-full border-[1px] border-black p-2">
            Units
          </th>
          <th class="w-[16.67%] h-full border-[1px] border-black p-2">
            Time
          </th>
          <th class="w-[16.67%] h-full border-[1px] border-black p-2">
            Days
          </th>
          <th class="w-[16.67%] h-full border-[1px] border-black py-2 px-4 rounded-tr-md flex justify-center">
            <button class="flex flex-row gap-1 items-center border-[1px] rounded-md transition-all p-2"
              [disabled]="this.semSubjects.length >= 7"
              [ngClass]="{'text-slate-400 border-green-300 bg-slate-50 cursor-default': this.semSubjects.length >= 7, 'border-green-600 bg-transparent hover:bg-green-600 text-green-600 hover:text-white' : this.semSubjects.length < 7}"
              (click)="addSemSubject()">
              <i class="material-symbols-outlined">
                add
              </i>
              <span class="md:block hidden">
                Add Subject
              </span>
            </button>
          </th>
        </tr>
      </thead>
      <tbody class="flex flex-col w-full h-[20rem] overflow-y-auto">
        @for(s of semSubjects.controls; let outerIndex = $index; track outerIndex){
          <tr class="w-full flex flex-row h-[3.54rem]">
            <td class="flex w-[16.67%] h-full border-[1px] border-black relative group">
              <select class="w-full border-[1px] py-2"
              (change)="courseSelected(outerIndex, $event)"
              [ngClass]="{'border-red-600 border-[1px]': getReqCourseControl(outerIndex).invalid }"
              [formControl]="getReqCourseControl(outerIndex)">
              <option [ngValue]="null" disabled>
                Please Select
              </option>
              @if(searchCourse.trim().length > 0 &&
                isSelectedCourseFiltered(outerIndex) == false &&
                getReqCourseControl(outerIndex).value != null
              ){
                <option
                  [disabled]="isCourseSelected(getSelectedCourse(getReqCourseControl(outerIndex).value).subjectid)"
                  [ngValue]="getSelectedCourse(getReqCourseControl(outerIndex).value).subjectid">
                  {{ getSelectedCourse(getReqCourseControl(outerIndex).value).subjectcode }}
                </option>
              }

              @for(course of courses | coursePipe:searchCourse; track $index) {
                <option
                  [disabled]="isCourseSelected(course.subjectid)"
                  [ngValue]="course.subjectid">
                  {{ course.subjectcode }}
                </option>
              }
            </select>
            @if(getReqCourseControl(outerIndex).invalid) {
              <img class="absolute right-0 top-0 h-full" src="../../../assets/exclamation-mark-inside-a-circle-svgrepo-com.svg"/>
              <div class="w-0 h-0 opacity-0 group-hover:opacity-100 group-focus:opacity-100 absolute top-[80%] right-4 border-l-[5px] border-l-transparent border-b-[10px] border-b-black border-r-[5px] border-r-transparent">
              </div>
              <div class="z-50 bg-black rounded-md absolute min-w-[20px] min-h-[30px] text-white top-[100%] right-0 p-2 opacity-0 group-hover:opacity-100 group-focus:opacity-100">
                @if(getReqCourseControl(outerIndex).hasError('required')){
                  Course is required!
                }
              </div>
            }
            </td>
            <td class="w-[16.67%] h-full border-[1px] border-black p-2">
              {{ getDescriptionControl(outerIndex).value != null ? getDescriptionControl(outerIndex).value : 'none set yet' }}
            </td>
            <td class="w-[16.67%] h-full border-[1px] border-black p-2">
              {{ getUnitsControl(outerIndex).value != null ? getUnitsControl(outerIndex).value : 'none set yet' }}
            </td>
            <td class="w-[16.67%] h-full border-[1px] border-black relative group">
              <select class="w-full h-full" [ngClass]="{'border-red-600 border-[1px]': getTimeControl(outerIndex).invalid }" [formControl]="getTimeControl(outerIndex)">
                <option [ngValue]="null" selected disabled>
                  Please Select
                </option>
                <option value="AM">
                  Morning
                </option>
                <option value="PM">
                  Afternoon
                </option>
              </select>
              @if(getTimeControl(outerIndex).invalid) {
                <img class="absolute right-0 top-0 h-full" src="../../../assets/exclamation-mark-inside-a-circle-svgrepo-com.svg"/>
                <div class="w-0 h-0 opacity-0 group-hover:opacity-100 group-focus:opacity-100 absolute top-[80%] right-4 border-l-[5px] border-l-transparent border-b-[10px] border-b-black border-r-[5px] border-r-transparent">
                </div>
                <div class="z-50 bg-black rounded-md absolute min-w-[20px] min-h-[30px] text-white top-[100%] right-0 p-2 opacity-0 group-hover:opacity-100 group-focus:opacity-100">
                  @if(getTimeControl(outerIndex).hasError('required')){
                    Time is required!
                  }
                </div>
              }
            </td>
            <td class="w-[16.67%] h-full border-[1px] border-black relative group">
              <select class="w-full h-full" [ngClass]="{'border-red-600 border-[1px]': getDaysControl(outerIndex).invalid }"  [formControl]="getDaysControl(outerIndex)">
                <option [ngValue]="null" selected disabled>
                  Please Select
                </option>
                <option value="M-Th">
                  Mon-Thu
                </option>
                <option value="T-F">
                  Tue-Fri
                </option>
                <option value="W-S">
                  Wed-Sat
                </option>
              </select>
              @if(getDaysControl(outerIndex).invalid) {
                <img class="absolute right-0 top-0 h-full" src="../../../assets/exclamation-mark-inside-a-circle-svgrepo-com.svg"/>
                <div class="w-0 h-0 opacity-0 group-hover:opacity-100 group-focus:opacity-100 absolute top-[80%] right-4 border-l-[5px] border-l-transparent border-b-[10px] border-b-black border-r-[5px] border-r-transparent">
                </div>
                <div class="z-50 bg-black rounded-md absolute min-w-[20px] min-h-[30px] text-white top-[100%] right-0 p-2 opacity-0 group-hover:opacity-100 group-focus:opacity-100">
                  @if(getDaysControl(outerIndex).hasError('required')){
                    Days are required!
                  }
                </div>
              }
            </td>
            <td class="w-[16.67%] h-full border-[1px] border-black p-2 flex items-center justify-center">
              <button class="border-[1px] border-red-600 text-red-600 hover:bg-red-600 hover:text-white transition-all p-2 flex justify-center items-center rounded-md"
                (click)="popSemSubject(outerIndex)">
                <i class="material-symbols-outlined">
                  delete
                </i>
              </button>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
  <div class="flex flex-row bg-white">
    <span class="font-bold w-[15rem] p-2 border-[1px] border-black">
      Total Units:
    </span>
    <span class="flex-auto p-2 border-[1px] border-black">
      {{ currentUnits }}
    </span>
  </div>
  <div class="flex h-[3rem] justify-end gap-2">
    <a [routerLink]="'/consultation'" class="w-full flex flex-row gap-2 items-center justify-center px-4 bg-slate-700 py-2 rounded-md text-white hover:bg-slate-900 transition-all uppercase">
      <i class="material-symbols-outlined">
        close
      </i>
      <span class="hidden lg:block">
        Discard
      </span>
    </a>
    <button class="w-full flex flex-row gap-2 px-4 py-2 items-center justify-center bg-green-600 border-[1px] rounded-md text-white transition-all hover:bg-green-800 uppercase" (click)="handleSubmit()">
      <i class="material-symbols-outlined">add</i>
      <span class="hidden lg:block">
        Add Consultation
      </span>
    </button>
  </div>
</form>
